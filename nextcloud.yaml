apiVersion: v1
kind: Pod
metadata:
  annotations:
    io.containers.autoupdate: registry
  creationTimestamp: "2024-06-26T09:29:04Z"
  labels:
    app: nextcloud
  name: nextcloud

spec:
  enableServiceLinks: false
  hostname: nextcloud
  restartPolicy: OnFailure

  containers:
    - name: maria-db
      image: docker.io/library/mariadb:10
      args:
        - --transaction-isolation=READ-COMMITTED
        - --log-bin=binlog
        - --binlog-format=ROW
      envFrom:
        - secretRef:
            name: nextcloud-db-secrets
      volumeMounts:
        - mountPath: /var/lib/mysql/:Z
          name: nextcloud_db

    - name: redis
      image: docker.io/library/redis:alpine
      args:
        - redis-server
        - --requirepass
        - $(REDIS_HOST_PASSWORD)
      envFrom:
        - secretRef:
            name: nextcloud-redis-secrets

    - name: nextcloud
      image: docker.io/library/nextcloud:fpm-alpine
      args:
        - php-fpm
      env:
        - name: REDIS_HOST
          value: 127.0.0.1
        - name: MYSQL_HOST
          value: 127.0.0.1
      envFrom:
        - secretRef:
            name: nextcloud-db-secrets
        - secretRef:
            name: nextcloud-redis-secrets
      volumeMounts:
        - mountPath: /var/www/html/:z
          name: nextcloud_html
        - mountPath: /var/www/html/data:z
          name: nextcloud_data

    - name: caddy
      image: docker.io/library/caddy:latest
      ports:
        - containerPort: 80
          hostPort: 8080
      volumeMounts:
        - mountPath: /var/www/html:ro,z
          name: nextcloud_html
        - mountPath: /data:Z
          name: nextcloud_caddy_data
        - mountPath: /etc/caddy/Caddyfile:Z
          name: nextcloud_caddyfile

    - name: collabora
      image: docker.io/collabora/code:latest
      ports:
        - containerPort: 9980
          hostPort: 9980
      envFrom:
        - secretRef:
            name: nextcloud-collabora-secrets
      env:
        - name: domain
          value: office.yourdomain.com # <-- change this
        - name: server_name
          value: office.yourdomain.com # <-- change this
        - name: extra_params
          value: --o:ssl.enable=false --o:ssl.termination=true

  volumes:
    # change paths to store data elsewhere
    # make sure you have write permissions
    - hostPath:
        path: caddy/caddy_data
        type: Directory
      name: nextcloud_caddy_data
    - hostPath:
        path: caddy/Caddyfile
        type: File
      name: nextcloud_caddyfile
    - hostPath:
        path: db
        type: Directory
      name: nextcloud_db
    - hostPath:
        path: html
        type: Directory
      name: nextcloud_html
    - hostPath:
        path: data
        type: Directory
      name: nextcloud_data
status: {}
